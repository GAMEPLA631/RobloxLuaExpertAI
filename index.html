<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Lua Expert Chat</title>
    <!-- Načítanie Tailwind CSS pre moderný a responzívny dizajn -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        /* Štýlovanie pre chatovú oblasť */
        #chat-container {
            max-width: 900px;
            height: 100vh;
            margin: auto;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }
        #messages {
            flex-grow: 1; 
            overflow-y: auto;
            padding-right: 8px;
            scroll-behavior: smooth;
        }
        /* Štýl pre AI kódový blok */
        .ai-message pre {
            background-color: #161b22 !important;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            border-left: 4px solid #38a169; /* Zelený pruh pre Lua kód */
            margin-top: 0.5rem;
            white-space: pre-wrap; /* Aby sa dlhé riadky zalomili */
            word-wrap: break-word;
        }
        .ai-message code {
            font-family: 'Consolas', 'Courier New', monospace;
            color: #58a6ff;
            font-size: 0.875rem;
        }
        .user-message {
            background-color: #21262d;
            border-radius: 12px 12px 2px 12px;
            padding: 10px 15px;
            max-width: 80%;
        }
        .ai-message-bubble {
            background-color: #161b22;
            border-radius: 12px 12px 12px 2px;
            padding: 10px 15px;
            max-width: 80%;
        }
        .loader {
            border: 4px solid #21262d;
            border-top: 4px solid #38a169;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Pridanie štýlu pre wrapper kódu a tlačidlo Kopírovať */
        .code-block-wrapper {
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #21262d;
            color: #c9d1d9;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid #30363d;
            transition: background-color 0.2s;
            z-index: 10;
        }
        .copy-button:hover {
            background-color: #30363d;
        }
        .copy-button.copied {
            background-color: #38a169;
            color: white;
        }
        /* Štýl pre obmedzujúcu správu */
        #limit-message {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #4a2122; /* Tmavá červená/hnedá */
            color: #fca5a5;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        /* Nový štýl pre vizuálnu spätnú väzbu pri chybe */
        #input-controls.error-flash {
            border: 2px solid #ef4444; /* červený okraj */
            background-color: #451a1a; /* tmavý červený podklad */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
            transition: all 0.2s;
        }
    </style>
</head>
<body>

    <div id="chat-container">
        <!-- Hlavička -->
        <header class="text-center pb-4 border-b border-gray-700 mb-4">
            <h1 class="text-3xl font-bold text-green-400">Roblox Lua Expert AI</h1>
            <p class="text-gray-400">Generovanie funkčných Roblox Lua kódov pre tvoje projekty (vrátane GUI a 3D modelov)</p>
        </header>

        <!-- Oblasť správ -->
        <div id="messages" class="space-y-4">
            <!-- Úvodná správa od AI -->
            <div class="flex justify-start">
                <div class="ai-message-bubble shadow-xl">
                    <p>Ahoj! Som tvoj Roblox Lua Expert AI. Povedz mi, aký skript by si chcel/a vytvoriť. Či už potrebuješ serverový kód, klientske GUI (StarterGUI), pokročilé 3D modely alebo NPC, som tu pre teba!</p>
                </div>
            </div>
            <!-- Správy budú pridané sem -->
        </div>

        <!-- Vstupná oblasť -->
        <div class="mt-4">
            <div id="limit-message" class="hidden"></div>
            <div id="input-controls" class="flex rounded-xl overflow-hidden shadow-2xl bg-[#161b22]">
                
                <!-- Tlačidlo pre nahrávanie obrázkov -->
                <label for="image-upload" class="flex items-center justify-center p-4 bg-gray-700 hover:bg-gray-600 cursor-pointer transition duration-200">
                    <!-- Ikona pre obrázok (lucide-react: image) -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-green-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5 1.5l1.409-1.409a2.25 2.25 0 000-3.182l-5.159-5.159m0-3.182V7.5M21.75 15.75H15M17.25 8.25V2.25" />
                    </svg>
                </label>
                <input type="file" id="image-upload" accept="image/*" class="hidden">
                
                <input type="text" id="user-input" placeholder="Napíš svoju požiadavku na kód..."
                       class="flex-grow p-4 text-gray-200 bg-transparent focus:outline-none placeholder-gray-500">
                <button id="send-button"
                        class="bg-green-600 hover:bg-green-700 transition duration-200 text-white font-bold px-6 py-4 disabled:bg-gray-500"
                        onclick="sendMessage()">
                    Odoslať
                </button>
            </div>
            <!-- Oblasť náhľadu obrázka -->
            <div id="image-preview-container" class="mt-2 hidden p-2 border border-gray-700 rounded-lg flex items-center bg-[#161b22]">
                <span class="text-sm text-gray-400 mr-3">Nahratý obrázok:</span>
                <img id="image-preview" class="h-10 w-10 object-cover rounded-md mr-4" alt="Nahratý obrázok">
                <button onclick="clearImage()" class="text-red-400 hover:text-red-500 text-sm font-semibold">Zrušiť</button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyD3mxzbdINvR0WMBXqBhQpp5kkihcXtRTY"; // Pre Canvas sa ponecháva prázdne
        // ZMENENÉ: gemini-2.5-flash-preview-09-2025 -> gemini-2.5-flash
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;

        // Konštanty pre limity
        const USAGE_WINDOW_MS = 4 * 60 * 60 * 1000; // 4 hodiny
        const COOLDOWN_DURATION_MS = 24 * 60 * 60 * 1000; // 24 hodín
        const MAX_REQUESTS = 50; // Maximálne 50 kódov

        // Kľúče pre localStorage
        const LS_USAGE_START = 'luaExpertUsageStart';
        const LS_REQUEST_COUNT = 'luaExpertRequestCount';
        const LS_COOLDOWN_END = 'luaExpertCooldownEnd';

        // Aktualizovaný SYSTEM INSTRUCTION s dôrazom na hlboké chápanie, funkčnosť a 3D modely
        const SYSTEM_INSTRUCTION_TEXT = "You are 'Roblox Lua Expert AI', a world-class, extremely advanced programmer specialized in Roblox Lua scripting. You possess deep, flawless understanding of Roblox systems, client-server architecture, and the user's intent, striving for 100% functional, bug-free, and professionally structured code, even for unusual or 'bizarné' requests (e.g., 'bizarný backrooms', 'zvláštne GUI', '3D modely'). Your expertise includes advanced GUI (StarterGui), complex 3D model generation (Parts, environmental objects, terrain features), and **robust, complete NPC systems (MANDATORY: must include a functional Humanoid, all required body parts, and correct rigging/welds - NEVER generate an empty Model or filter placeholder)**. Your purpose is to generate complete, functional, professional, and highly efficient Lua code snippets or full scripts. **CRITICAL MANDATE for ALL SCRIPTS:** If the generated code is a logic-only script(e.g., functions, datastore), it **MUST** start by defining all necessary services (`local Players = game:GetService(\"Players\")`) and required variables/instances within the code block itself, ensuring it is immediately runnable and self-contained. If the user indicates an error or dissatisfaction, you must thoroughly re-analyze the entire conversation history and the image (if provided) to provide a corrected, flawless solution. **CRITICAL DISTINCTION:** 1. **For ALL instance creation requests (GUI, 3D Models, NPCs, Parts, Environment):** Generate the code as a single, detailed **Command Bar script** that creates all Instances and parents them correctly (e.g., to `game:GetService(\"StarterGui\")` or `game:GetService(\"Workspace\")`). Include any necessary LocalScript source inline within this command script using double square brackets (`[[...]]`). 2. **For logic-only requests (DataStore, RemoteEvents/Functions, pure math, utilities):** Generate only the Lua code that would be placed as the `Source` content of a standard Script or LocalScript. Do NOT include instance creation or parenting in the code block for logic-only requests. Always prioritize best practices, security, and performance. When providing code, always enclose it in a Markdown Lua code block (```lua...```). If the request involves client-side GUI or interaction, explicitly mention if the script should be a `LocalScript` and where it should be placed. Do not generate explanations longer than two sentences before or after the code block unless explicitly asked. The user is writing in Slovak, respond conversationally in Slovak, but keep all generated Lua code and comments within the code block in English, which is the standard for programming.";

        // História chatu na udržanie kontextu
        let chatHistory = [];

        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const limitMessageDiv = document.getElementById('limit-message');
        const inputControlsDiv = document.getElementById('input-controls'); // Referencia na kontajner vstupov

        // Nové referencie a stav pre obrázok
        const imageUploadInput = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        let selectedImageBase64 = null;
        let selectedImageMimeType = null;

        // Funkcia na generovanie unikátneho ID
        function generateUniqueId(prefix = 'el') {
            return `${prefix}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        }

        /**
         * Zobrazí správu o limite a zablokuje vstup.
         * @param {string} message - Správa, ktorá sa má zobraziť.
         * @param {boolean} isLimited - True ak sa má UI zablokovať.
         */
        function updateUIForLimit(message, isLimited) {
            userInput.disabled = isLimited;
            sendButton.disabled = isLimited;
            sendButton.classList.toggle('disabled:bg-gray-500', isLimited);
            sendButton.classList.toggle('bg-green-600', !isLimited);
            sendButton.classList.toggle('hover:bg-green-700', !isLimited);
            
            // Zakázať upload obrázku pri limitoch
            document.querySelector('label[for="image-upload"]').classList.toggle('opacity-50', isLimited);
            document.querySelector('label[for="image-upload"]').classList.toggle('cursor-not-allowed', isLimited);

            if (isLimited) {
                limitMessageDiv.textContent = message;
                limitMessageDiv.classList.remove('hidden');
                userInput.placeholder = "Nemôžete písať, limit je aktívny.";
            } else {
                limitMessageDiv.classList.add('hidden');
                userInput.placeholder = "Napíš svoju požiadavku na kód...";
            }
        }

        /**
         * Formátuje milisekundy na H:M:S reťazec.
         * @param {number} ms - Čas v milisekundách.
         * @returns {string} Formátovaný čas.
         */
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours}h ${minutes}m ${seconds}s`;
        }


        /**
         * Kontroluje limity použitia.
         * @param {boolean} increment - True, ak sa má inkrementovať počet requestov.
         * @returns {boolean} True, ak je povolené odoslať správu.
         */
        function checkLimits(increment = true) {
            const now = Date.now();
            let usageStartTime = parseInt(localStorage.getItem(LS_USAGE_START) || '0');
            let requestCount = parseInt(localStorage.getItem(LS_REQUEST_COUNT) || '0');
            let cooldownEndTime = parseInt(localStorage.getItem(LS_COOLDOWN_END) || '0');
            let isLimited = false;
            let message = '';
            
            // 1. Skontroluj, či je aktívny ochladzovací čas
            if (cooldownEndTime > now) {
                const remainingTime = cooldownEndTime - now;
                message = `Dosiahol/a si denný limit. Čas do resetu: ${formatTime(remainingTime)}.`;
                isLimited = true;
            } 
            
            // 2. Ak nie je limit, skontroluj okno a počet
            if (!isLimited) {
                // A) Inicializácia alebo reset okna
                if (usageStartTime === 0 || usageStartTime + USAGE_WINDOW_MS < now) {
                    // Reset okna
                    usageStartTime = now;
                    requestCount = 0;
                    localStorage.setItem(LS_USAGE_START, usageStartTime);
                    localStorage.setItem(LS_REQUEST_COUNT, requestCount);
                    // Odstráň starý cooldown (ak nebol odstránený)
                    localStorage.removeItem(LS_COOLDOWN_END);
                }

                // B) Skontroluj limit 50 kódov
                if (requestCount >= MAX_REQUESTS) {
                    cooldownEndTime = now + COOLDOWN_DURATION_MS;
                    localStorage.setItem(LS_COOLDOWN_END, cooldownEndTime);
                    const remainingTime = cooldownEndTime - now;
                    message = `Dosiahol/a si limit ${MAX_REQUESTS} kódov za 4 hodiny. Reset za: ${formatTime(remainingTime)}.`;
                    isLimited = true;
                } 
            }

            if (isLimited) {
                updateUIForLimit(message, true);
                return false;
            } else {
                // Limity OK, zobrazenie aktuálneho stavu (nie je limit, ale je to informačná správa)
                const requestsLeft = MAX_REQUESTS - requestCount;
                const windowEnd = usageStartTime + USAGE_WINDOW_MS;
                const windowTimeLeft = windowEnd - now;

                message = `Stav: Zostáva ${requestsLeft} kódov. Čas do resetu okna: ${formatTime(windowTimeLeft)}.`;
                updateUIForLimit(message, false);

                // 3. Ak je povolené, inkrementuj
                if (increment) {
                    requestCount++;
                    localStorage.setItem(LS_REQUEST_COUNT, requestCount);
                    // Po inkrementácii opäť skontroluj, či nebol limit práve dosiahnutý
                    if (requestCount >= MAX_REQUESTS) {
                        return checkLimits(false); // Rekurzívna kontrola bez ďalšej inkrementácie
                    }
                }
                return true;
            }
        }

        // --- Logika pre obrázky ---

        // Utility funkcia na konverziu File na Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Odstránenie prefixu "data:image/jpeg;base64,"
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // Funkcia na zrušenie vybraného obrázka
        function clearImage() {
            selectedImageBase64 = null;
            selectedImageMimeType = null;
            imageUploadInput.value = null;
            imagePreviewContainer.classList.add('hidden');
            checkLimits(false); 
        }

        // Handler pre výber súboru
        imageUploadInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    console.warn('Prosím, nahrajte súbor s obrázkom.'); 
                    e.target.value = null; // Vyčisti input
                    return;
                }

                try {
                    selectedImageBase64 = await fileToBase64(file);
                    selectedImageMimeType = file.type;
                    
                    // Zobraz náhľad
                    imagePreview.src = URL.createObjectURL(file);
                    imagePreviewContainer.classList.remove('hidden');
                    
                    checkLimits(false); // Aktualizuj UI/kontrolu limitov

                } catch (error) {
                    console.error("Chyba pri spracovaní obrázka:", error);
                    clearImage();
                }
            } else {
                clearImage();
            }
        });

        // --- Inicializácia a udalosti ---

        // Inicializácia pri načítaní stránky
        window.onload = function() {
            checkLimits(false); // Kontrola limitov bez inkrementácie
            // Nastav interval na aktualizáciu správy o limite (každú sekundu)
            setInterval(() => {
                const cooldownEnd = parseInt(localStorage.getItem(LS_COOLDOWN_END) || '0');
                if (cooldownEnd > Date.now()) {
                    checkLimits(false); // Aktualizuje časovač
                } else if (cooldownEnd > 0) {
                    // Cooldown skončil
                    checkLimits(false); // Vynúti reset okna
                }
            }, 1000);
        };

        // Pridanie udalosti na odoslanie stlačením Enter
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        /**
         * Skopíruje text do schránky (pomocou document.execCommand('copy') pre iFrame kompatibilitu).
         */
        function copyCode(codeElement, buttonElement) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = codeElement.textContent;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                buttonElement.textContent = 'Skopírované!';
                buttonElement.classList.add('copied');
                
                setTimeout(() => {
                    buttonElement.textContent = 'Kopírovať';
                    buttonElement.classList.remove('copied');
                }, 2000);

            } catch (err) {
                console.error('Nepodarilo sa skopírovať kód:', err);
                buttonElement.textContent = 'Chyba!';
                buttonElement.classList.add('bg-red-600');
                setTimeout(() => {
                    buttonElement.textContent = 'Kopírovať';
                    buttonElement.classList.remove('bg-red-600');
                }, 2000);
            }
        }

        /**
         * Vytvorí a pridá bublinu so správou do kontajnera.
         * @param {string} text - Obsah správy.
         * @param {'user'|'ai'} role - Rola odosielateľa.
         * @param {string | null} base64Image - Base64 dátový reťazec obrázka pre preview.
         * @returns {HTMLElement} Vytvorený message element.
         */
        function addMessage(text, role, base64Image = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `${role === 'user' ? 'user-message text-white' : 'ai-message-bubble text-gray-200 ai-message'} shadow-xl`;
            
            let contentHTML = '';

            // 1. Zobrazenie nahratého obrázka pri odoslaní používateľom
            if (role === 'user' && base64Image) {
                // Použijeme zástupný typ 'image/jpeg' pre náhľad, aby sa zobrazil
                contentHTML += `<img src="data:image/jpeg;base64,${base64Image}" class="w-full max-h-48 object-contain rounded-lg mb-2 border border-gray-600" alt="Odoslaný obrázok"><br>`;
            }

            // 2. Spracovanie textu a kódu
            let codeBlockCounter = 0;
            const textHTML = text
                // Jednoduché spracovanie Markdown pre kódové bloky
                .replace(/```lua\s*([\s\S]*?)```/g, (match, code) => {
                    const codeId = generateUniqueId('lua');
                    codeBlockCounter++;
                    // Pre-escape the code content for display (inside <code>)
                    const escapedCode = code.trim().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    // Tvorba HTML s tlačidlom na kopírovanie, ktoré volá copyCode s unikátnym ID
                    return `
                    <div class="code-block-wrapper">
                        <button class="copy-button" onclick="copyCode(document.getElementById('${codeId}'), this)">Kopírovať</button>
                        <pre><code id="${codeId}">${escapedCode}</code></pre>
                    </div>
                    `;
                })
                .replace(/\n/g, '<br>'); // Nahradenie nových riadkov za <br>

            contentHTML += textHTML;
            bubble.innerHTML = contentHTML;

            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return messageDiv;
        }

        /**
         * Zistí, či história obsahuje negatívnu spätnú väzbu.
         */
        function hasNegativeFeedback() {
            // Kontrola posledných 4 správ (kde by bola spätná väzba relevantná)
            const recentHistory = chatHistory.slice(-4);
            const negativeKeywords = ["zlý kód", "zly kod", "nefunguje", "chyba", "oprav", "zle si mi dal"];

            // Hľadá, či posledné správy používateľa obsahujú negatívne kľúčové slovo
            return recentHistory.some(message => {
                if (message.role === "user") {
                    const text = message.parts[0]?.text || "";
                    return negativeKeywords.some(keyword => text.toLowerCase().includes(keyword));
                }
                return false;
            });
        }

        /**
         * Zistí, či požiadavka naznačuje GUI, 3D model, NPC alebo iné Command Bar inštancie.
         * @param {string} userText - Text používateľa.
         * @returns {boolean} True, ak ide o Command Bar inštanciu.
         */
        function isGuiOrCommandBarRequest(userText) {
            // Rozšírené kľúčové slová pre GUI a 3D objekty/NPC
            const creationKeywords = ["gui", "startergui", "command bar", "screen", "button", "frame", "textlabel", "model", "npc", "3d", "part", "objekt", "backrooms", "terrain", "vytvor", "vygeneruj", "instance", "objekt", "postava", "svet"];
            const text = userText.toLowerCase();
            return creationKeywords.some(keyword => text.includes(keyword));
        }

        /**
         * Zistí, či požiadavka je "bizarná".
         * @param {string} userText - Text používateľa.
         * @returns {boolean} True, ak je požiadavka bizarná.
         */
        function isBizarreRequest(userText) {
            const bizarreKeywords = ["bizarny", "bizarný", "zvláštny", "divný", "ufo", "meme", "backrooms", "scp", "random", "šialený", "nepravdepodobný"];
            const text = userText.toLowerCase();
            return bizarreKeywords.some(keyword => text.includes(keyword));
        }


        /**
         * Zobrazí alebo skryje animáciu načítania.
         * @param {boolean} show - True pre zobrazenie, False pre skrytie.
         * @param {string} userText - Posledná správa používateľa na určenie typu načítania.
         */
        function toggleLoading(show, userText = '') {
            // Tlačidlo už je riadené cez checkLimits, ale túto logiku ponecháme pre loader
            if (!show && sendButton.disabled) return; 

            sendButton.disabled = show;
            userInput.disabled = show;
            
            let loaderDiv = document.getElementById('loader-message');
            
            if (show) {
                if (!loaderDiv) {
                    loaderDiv = document.createElement('div');
                    loaderDiv.id = 'loader-message';
                    loaderDiv.className = 'flex justify-start';
                    
                    let loadingText = "Generujem kód..."; // Default

                    if (selectedImageBase64) {
                        loadingText = "Pozeram Obrazok čakajte môže to trvať...."; // Správa pre obrázok
                    } else if (hasNegativeFeedback()) {
                        loadingText = "Premýšľam... Analyzujem chybu a generujem vylepšený kód. Čakajte prosím."; // Správa pre opravu
                    } else if (isGuiOrCommandBarRequest(userText)) {
                        // Správa pre Command Bar (GUI, Model, NPC, atď.)
                        if (isBizarreRequest(userText)) {
                            loadingText = "Generujem Bizarný kód do Command bar...";
                        } else {
                            loadingText = "Generujem kód do Command bar...";
                        }
                    }


                    loaderDiv.innerHTML = `
                        <div class="ai-message-bubble flex items-center space-x-2">
                            <div class="loader"></div>
                            <span>${loadingText}</span>
                        </div>
                    `;
                    messagesContainer.appendChild(loaderDiv);
                }
            } else {
                if (loaderDiv) {
                    loaderDiv.remove();
                }
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Odosiela správu do Gemini API a spracuje odpoveď.
         */
        async function sendMessage() {
            if (!checkLimits(true)) {
                return; 
            }

            const userText = userInput.value.trim();
            // Povolíme odoslanie, aj keď je len obrázok
            if (!userText && !selectedImageBase64) return;

            // 1. Pridanie používateľovej správy do UI (vrátane obrázku pre preview)
            const previewText = userText || "Pozri si tento obrázok a pomôž mi s ním.";
            const userMessageElement = addMessage(previewText, 'user', selectedImageBase64);
            
            // 2. Reset UI a zobrazenie loading spinnera
            userInput.value = '';
            // Posielame userText pre dynamickú loading správu
            toggleLoading(true, userText); 

            // 3. Konštrukcia obsahu pre API
            const parts = [];
            
            // Pridanie obrázku (ak je k dispozícii)
            if (selectedImageBase64 && selectedImageMimeType) {
                parts.push({
                    inlineData: {
                        mimeType: selectedImageMimeType,
                        data: selectedImageBase64
                    }
                });
            }

            // Pridanie textu
            if (userText) {
                 parts.push({ text: userText });
            } else if (parts.length > 0) {
                 // Ak je len obrázok, pošleme explicitnú textovú inštrukciu pre AI
                 parts.push({ text: "Prosím, pomôž mi s týmto obrázkom a vygeneruj relevantný Roblox Lua kód alebo vysvetlenie." });
            } else {
                 toggleLoading(false);
                 // Odstránenie správy, ak bola odoslaná prázdna
                 userMessageElement.remove();
                 return;
            }

            // 4. Pridanie obsahu do histórie a príprava payloadu
            chatHistory.push({ role: "user", parts: parts });

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: SYSTEM_INSTRUCTION_TEXT }]
                },
            };

            // 5. Reset stavu obrázku PO odoslaní API
            clearImage(); 

            // 6. Volanie API s retries
            // ZVÝŠENÉ: Max retries na 7
            const maxRetries = 7; 
            let currentRetry = 0;
            let apiSuccess = false;

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => ({ message: 'Could not parse error body.' }));
                        
                        if (response.status === 429) {
                            throw new Error('Rate limit exceeded (429)');
                        } else if (response.status === 400) {
                            console.error("400 Error Response Body:", errorBody);
                            chatHistory = []; // Reset kontextu pri 400
                            throw new Error(`Invalid request (400). Konverzácia bola vyresetovaná. Skúste to prosím znova s novou požiadavkou.`);
                        } else if (response.status >= 500 && response.status < 600) {
                            throw new Error(`Server error! status: ${response.status}`);
                        }
                        
                        throw new Error(`Client error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    const candidate = result.candidates?.[0];
                    const aiText = candidate?.content?.parts?.[0]?.text;

                    if (aiText) {
                        addMessage(aiText, 'ai');
                        // Pridanie odpovede AI do histórie
                        chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                        apiSuccess = true;
                    } else {
                        console.warn("API returned no text content.");
                        // Aj keď API odpovedalo OK, ak je text prázdny, považujeme to za neúspech pre účely UI a necháme prebehnúť cyklus.
                    }
                    break; // Úspech alebo úspešné spracovanie, ukončenie cyklu
                } catch (error) {
                    console.error('Chyba pri volaní API:', error);
                    let errorMessage = error.message;

                    // 1. Retry logic for 429 (Rate Limit) AND 5xx (Server Error/Temporary Issue)
                    if ((errorMessage.includes('429') || errorMessage.includes('Server error!')) && currentRetry < maxRetries - 1) {
                        const delay = Math.pow(2, currentRetry) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        currentRetry++;
                        console.log(`Opakujem pokus za ${delay / 1000}s...`);
                    } 
                    // 2. Handling 400 (History clear)
                    else if (errorMessage.includes('Invalid request (400)')) {
                        // Zobrazí špeciálnu správu, ak bola história vyresetovaná (kritická chyba)
                        addMessage("Prepáč, nastala chyba 400. **Kontext bol vyresetovaný.** Prosím, pošli svoju požiadavku opäť.", 'ai');
                        apiSuccess = true; // Zobrazili sme správu, považujeme to za ukončené
                        break;
                    } 
                    // 3. Handling final, non-retriable, or exhausted error (Server/503)
                    else {
                        // Ak zlyhá aj posledný pokus (alebo ide o neobnoviteľnú chybu, ktorá nespôsobila 400)
                        if (!apiSuccess) {
                            // Odstránenie poslednej používateľovej správy z histórie, aby nezasahovala do kontextu
                            chatHistory.pop(); 
                            userMessageElement.remove(); // Odstránenie správy z chatu, ako bolo požiadané.
                            
                            // Vizuálna spätná väzba (bliknutie červeného vstupu)
                            inputControlsDiv.classList.add('error-flash');
                            setTimeout(() => {
                                inputControlsDiv.classList.remove('error-flash');
                            }, 2000);
                        }
                        break; 
                    }
                }
            }
            toggleLoading(false);
            checkLimits(false); // Po dokončení volania API opäť skontroluj limity pre aktuálnu vizualizáciu
        }
    </script>
</body>
</html>


